# お供物配分システム実装計画書

## 概要

香典アプリにおけるお供物配分システムの設計・実装に関する包括的な計画書。
連名でお供物を提供した場合の配分管理と、香典返しとの関連付けを効率的に行うシステムを構築する。

## 現状分析（実施済み）

### 発見された問題

1. **データ不整合の深刻な問題**
   - 香典エントリー：1,460件
   - お供物フラグ付き：313件（21%）
   - 実際のお供物：13件のみ
   - `has_offering`フラグが304件で不整合

2. **過剰なマイグレーション実行**
   - 今日だけで20以上のマイグレーション実行
   - `return_entry_records`で12,113回INSERT、9,988回UPDATE（最終1,460行）

3. **トリガーの問題**
   - 5個の重複トリガーが存在
   - 監査ログトリガーの設定不備

## 実装済み機能

### フェーズ1: 緊急修正（完了）

#### 1.1 データ整合性修正
- [x] `has_offering`フラグの不整合304件を完全修正
- [x] 過剰なトリガー（5個）を整理して1個に削減
- [x] 監査ログトリガーの問題解決

#### 1.2 新しいお供物配分システム構築
- [x] `offering_allocations`テーブル作成
  ```sql
  CREATE TABLE offering_allocations (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    offering_id uuid REFERENCES offerings(id) ON DELETE CASCADE,
    kouden_entry_id uuid REFERENCES kouden_entries(id) ON DELETE CASCADE,
    allocated_amount integer NOT NULL,
    allocation_ratio decimal(5,4) NOT NULL,
    is_primary_contributor boolean DEFAULT false,
    contribution_notes text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    created_by uuid REFERENCES auth.users(id)
  );
  ```

- [x] 既存の`offering_entries`から新システムへデータ移行（11件の配分レコード）
- [x] RLSポリシー設定
- [x] 整合性チェック機能実装

### フェーズ2: Server Actions実装（完了）

#### 2.1 配分管理Actions
- [x] `src/app/_actions/offerings/allocation.ts`
  - `allocateOfferingToEntries()` - お供物配分機能
  - `removeOfferingAllocation()` - 配分削除
  - `recalculateOfferingAllocation()` - 配分再計算
  - 均等配分・手動配分・重み付け配分サポート

#### 2.2 データ取得Actions
- [x] `src/app/_actions/offerings/queries.ts`
  - `getOfferingAllocations()` - 配分データ取得
  - `getEntryOfferingAllocations()` - 香典エントリー関連配分取得
  - `checkOfferingAllocationIntegrity()` - 整合性チェック
  - `calculateEntryTotalAmount()` - 合計金額計算

### フェーズ3: UIコンポーネント実装（完了）

#### 3.1 配分管理UI
- [x] `OfferingAllocationDialog.tsx`実装
  - 配分方法選択（均等・手動・重み付け）
  - 香典エントリー選択UI
  - 主要提供者選択
  - リアルタイム整合性チェック
  - 手動配分時の金額入力・検証
  - アクセシビリティ対応

#### 3.2 型定義整備
- [x] 複数の型エラー修正
  - `string | null`型をstring型に割り当てる問題解決
  - switch文のブロックスコープ問題修正
  - OfferingAllocation型定義とSupabase実際の型の整合性確保

### フェーズ4: 統合テスト実装（完了）

#### 4.1 包括的テストスイート作成
- [x] `allocation.test.ts` - 配分ロジックテスト
  - 均等配分の動作確認（余り処理含む）
  - 手動配分の検証機能
  - エラーハンドリングの確認
  - 主要提供者の設定テスト

- [x] `queries.test.ts` - データ取得機能テスト
  - 配分データ取得の動作確認
  - 香典エントリー関連配分の取得
  - 整合性チェック機能
  - 合計金額計算の検証

- [x] `integration.test.ts` - システム統合テスト
  - 配分作成から削除までの完全フロー
  - データ整合性の維持確認
  - エラー処理の統合動作

- [x] `ui-integration.test.tsx` - Server Actions統合テスト
  - モック化された環境でのAPI動作確認
  - エラーハンドリングの検証
  - 型安全性の確認

#### 4.2 テスト品質の向上
- [x] エラーハンドリングの改善
  - 具体的なエラーメッセージの返却
  - `Error`インスタンスの適切な処理
  - try-catch構造の最適化

- [x] 25個のテストケース全通過
  - allocation: 9テスト
  - queries: 10テスト  
  - integration: 6テスト
  - ui-integration: 5テスト（モック版）

#### 4.3 技術的課題の解決
- [x] TypeScript型import問題の解決
  - `import type` vs `import`の適切な使い分け
  - JSXテストファイルの拡張子修正（.ts → .tsx）
  - モックシステムの構築

## 設計思想と解決策

### 連名お供物問題の解決

**従来の問題:**
- お花を3人で連名で出した場合、配分方法が不明確
- 後から関連者を追加した際の整合性問題

**新システムの解決策:**
- 明示的な配分金額記録（`allocated_amount`）
- 配分比率も記録（`allocation_ratio`）で再計算が容易
- 主要提供者の概念導入（`is_primary_contributor`）で責任の所在を明確化

### 配分方法

1. **均等配分**: 価格を人数で等分（余りは最初の人に加算）
2. **手動配分**: 個別に金額を指定（合計チェック付き）
3. **重み付け配分**: 香典金額に応じた配分（将来実装）

## 今後の実装計画

### フェーズ5: 実装統合とUI連携（完了）

#### 5.1 実際のページへの統合 ✅ **完了**
- [x] **お供物一覧ページでの配分管理機能統合**
  - デスクトップ版テーブルに「配分管理」カラム追加
  - モバイル版DrawerContentに配分管理ボタン追加
  - 価格未設定時の適切な表示制御
  - 権限チェック付きボタン表示（owner/editor権限）
  - `OfferingAllocationDialog`コンポーネントとの完全統合

- [x] **UIコンポーネント統合の技術的実装**
  - `src/app/(protected)/koudens/[id]/offerings/_components/table/columns.tsx`
    - 新しい「配分管理」カラムの追加
    - 型安全な`typeLabels`アクセス実装
    - 適切なprops渡しとエラーハンドリング
  
  - `src/app/(protected)/koudens/[id]/offerings/_components/card-list/`
    - `offering-card.tsx`: entriesパラメータの追加
    - `offering-drawer-content.tsx`: 配分管理ボタンの統合
    - モバイル版でのフル機能アクセス確保

- [x] **型安全性とエラー修正**
  - TypeScript型エラーの完全解決
  - `offering.type as OfferingType`キャストの適切な実装
  - インポート構造の最適化

#### 5.2 統合の品質確保
- [x] **デスクトップ・モバイル両対応**
  - レスポンシブデザインでの一貫したUX
  - 各プラットフォームでの適切な操作性
  - 権限管理の統一実装

- [x] **実装統合テスト準備完了**
  - 開発環境での動作確認可能
  - 本格的なE2Eテスト準備完了
  - ユーザビリティテスト準備完了

### フェーズ6: 返礼管理システム統合（完了）

#### 6.1 返礼管理ヘルパー実装 ✅ **完了**
- [x] **返礼情報データ変換ヘルパー作成**
  - `src/utils/return-records-helpers.ts`実装
  - `convertToReturnManagementSummary()`: 単体変換機能
  - `convertToReturnManagementSummaries()`: 一括変換機能
  - お供物配分金額の実際値取得統合（`calculateEntryTotalAmount`活用）

- [x] **型安全性の確保**
  - `ReturnManagementSummary`型定義との完全整合
  - `createdAt/updatedAt` → `returnRecordCreated/returnRecordUpdated`修正
  - `getStatusDisplay()`ヘルパー関数追加
  - `needsAdditionalReturn`フラグ計算実装

- [x] **返礼管理ページ統合**
  - 返礼記録ページでの配分込み金額表示
  - 実際のお供物配分額を反映した合計金額計算
  - データ変換処理の効率化

#### 6.2 ビルド・品質確保 ✅ **完了**
- [x] **TypeScript型エラー完全解決**
  - 全型エラー修正完了
  - bun buildで18秒での正常ビルド確認
  - 警告はSupabase依存関係のみ（コード品質問題なし）

#### 6.3 返礼情報一覧での配分状況可視化 ✅ **完了** 🎯 **フェーズ7として実装**
- [x] **返礼情報テーブルに配分状況カラム強化**
  - お供物配分詳細のより詳細な表示実装
  - 配分件数、総額、展開ボタンによる詳細情報提供
  - 配分あり/なしの視覚的インディケーター追加
- [x] **配分詳細の展開表示機能**
  - EntryAllocationDialogとの統合完了
  - お供物種類・価格・配分者一覧表示
  - 配分比率と実際の配分金額表示
  - 主要提供者の明示機能
- [x] **統計画面での配分込み金額計算実装**  
  - 通常統計・管理者統計両方で配分込み金額対応
  - 香典のみ・お供物配分・合計の分離表示
  - 配分込み金額ベースの分布計算実装
- [x] **配分済み/未配分の視覚的インディケーター**
  - テーブル・カードリスト両方での配分状況表示
  - バッジとアイコンによる直感的な状況把握
  - 色分けによる配分ありなしの明確化

### フェーズ7: 返礼情報一覧での配分状況可視化（完了） ✅

#### 7.1 返礼情報テーブル強化 ✅ **完了**
- [x] **お供物配分カラムの詳細表示実装**
  - `src/app/(protected)/koudens/[id]/return_records/_components/table/columns.tsx`更新
  - 配分件数・総額・展開ボタンによる詳細表示
  - 配分なしの場合の「配分なし」インディケーター
  - EntryAllocationDialogとの統合

#### 7.2 統計画面での配分込み金額計算 ✅ **完了**  
- [x] **通常統計ページ実装**
  - `src/app/(protected)/koudens/[id]/statistics/page.tsx`更新
  - 各エントリーの配分込み総額を並列取得
  - 香典のみ・お供物配分・合計の分離表示
  - 配分込み金額ベースの分布計算

- [x] **管理者統計ページ実装**
  - `src/app/(system)/admin/koudens/[id]/statistics/page.tsx`更新
  - 管理者権限での配分込み統計表示
  - 同様の詳細分析機能実装

- [x] **統計表示コンポーネント強化**
  - `src/app/(protected)/koudens/[id]/statistics/_components/index.tsx`更新
  - 配分込み総額の詳細表示（香典+お供物配分の内訳）
  - 金額別分布での配分込み表示

#### 7.3 カードリストでの配分状況表示 ✅ **完了**
- [x] **返礼カード詳細表示**
  - `src/app/(protected)/koudens/[id]/return_records/_components/card-list/return-card.tsx`更新
  - お供物配分の詳細表示（件数・金額・配分詳細ボタン）
  - 配分ありなしでの表示分岐
  - 合計金額の正確な計算と表示

#### 7.4 視覚的インディケーター実装 ✅ **完了**
- [x] **配分状況の色分け表示**
  - 配分ありの場合：緑色での強調表示
  - 配分なしの場合：グレー表示とアイコン
  - バッジによる件数表示

### フェーズ8: 次段階の機能拡張（計画中）

#### 8.1 パフォーマンス最適化
- [ ] 大量のお供物・香典データでの動作確認
- [ ] 配分計算の最適化
- [ ] リアルタイム更新の実装
- [ ] クエリパフォーマンスの監視

#### 8.2 エラーハンドリング強化
- [x] 基本的なエラーハンドリング実装済み
- [ ] ユーザーフレンドリーなエラーメッセージ
- [ ] データ復旧機能
- [ ] 操作取り消し機能

#### 7.3 UI/UX改善
- [x] モバイル対応の最適化（基本実装完了）
- [ ] 配分プレビュー機能
- [ ] 操作フローの改善
- [ ] アクセシビリティの向上

### フェーズ8: 共有返礼システム（2-3週間）

#### 8.1 返礼品共有機能
- [ ] 共有グループの概念導入
- [ ] 代表者による一括返礼機能
- [ ] 費用分担計算機能

#### 8.2 返礼品推奨システム
- [ ] 合計金額に基づく返礼品提案
- [ ] 返礼率の自動計算
- [ ] カスタマイズ可能な返礼設定

#### 8.3 一括操作機能
- [ ] 複数お供物の一括配分
- [ ] 配分パターンのテンプレート化
- [ ] 一括配分の履歴管理

### フェーズ9: 高度な機能・最終調整（1ヶ月）

#### 9.1 重み付け配分の実装
- [ ] 香典金額に基づく自動重み付け
- [ ] カスタム重み設定機能
- [ ] 複雑な配分ルールのサポート

#### 9.2 レポート機能
- [ ] 配分状況レポート
- [ ] 返礼状況一覧
- [ ] 統計情報の表示
- [ ] 配分効率性の分析

#### 9.3 監査機能・完成度向上
- [ ] 配分変更履歴の追跡
- [ ] 承認ワークフロー
- [ ] データ整合性の自動チェック
- [ ] 運用ドキュメント整備

## 技術的考慮事項

### データベース設計

```sql
-- 将来の拡張を考慮した設計
offering_allocations {
  id: uuid (PK)
  offering_id: uuid (FK)
  kouden_entry_id: uuid (FK)
  allocated_amount: integer -- 固定配分金額
  allocation_ratio: decimal -- 配分比率（再計算用）
  is_primary_contributor: boolean -- 主要提供者フラグ
  contribution_notes: text -- 配分メモ
  created_at: timestamptz
  updated_at: timestamptz
  created_by: uuid (FK)
}
```

### パフォーマンス最適化

- インデックス設計の最適化
- クエリパフォーマンスの監視
- キャッシュ戦略の検討

### セキュリティ

- RLSポリシーの適切な設定
- 操作権限の管理
- データ改ざん防止機能

## マイルストーン

| フェーズ | 期間 | 主要成果物 | 完了条件 |
|---------|------|-----------|----------|
| フェーズ1 | ✅完了 | データ修正・基盤構築 | 整合性問題解決 |
| フェーズ2 | ✅完了 | Server Actions | API機能完成 |
| フェーズ3 | ✅完了 | UIコンポーネント | 基本操作可能 |
| フェーズ4 | ✅完了 | 統合テスト | 25テスト全通過 |
| フェーズ5 | ✅完了 | UI統合・実装連携 | お供物ページで配分機能動作 |
| フェーズ6 | ✅完了 | 返礼管理システム統合 | 返礼ページで配分込み金額表示 |
| フェーズ7 | ✅完了 | 返礼情報配分表示強化 | 返礼一覧でお供物配分詳細表示・統計画面配分込み計算 |
| フェーズ8 | 2-3週間 | 共有返礼機能 | 複雑なケース対応 |
| フェーズ9 | 1ヶ月 | 高度機能・完成 | 完全な運用システム |

## 質問への回答

### Q1: 香典返しは必ず香典情報(kouden_entries)と紐づくイメージで問題ないか？
**A1:** ✅ 正解。基本は1:1紐づけで、将来的にグループ機能で拡張予定

### Q2: 連名でお花などを出している場合、お供物の金額を連名している香典情報の数で割れば良いか？
**A2:** ✅ 新しい`offering_allocations`システムで解決。明示的な配分金額記録により柔軟な配分が可能

### Q3: 後から関連する香典情報を追加する場合の整合性をどう取るか？
**A3:** ✅ 配分比率も記録しているため、後から関連者を追加しても再計算で整合性維持可能

## 注意事項

- **データ整合性の維持**: 配分変更時は必ず整合性チェックを実行
- **段階的リリース**: 各フェーズ完了後に十分なテストを実施
- **ユーザー教育**: 新機能の使い方をユーザーに適切に伝達
- **バックアップ**: 重要なデータ変更前は必ずバックアップを取得

## 📈 現在の進捗状況（2024年1月30日更新）

### ✅ 完了済み（フェーズ1-7）
- **データ基盤構築・修正**: 304件の不整合解決
- **配分システムAPI**: 完全実装（allocation.ts, queries.ts）
- **UIコンポーネント**: OfferingAllocationDialog完成
- **包括的テスト**: 25テストケース全通過
- **UI統合完了**: お供物一覧ページでの配分管理機能統合（デスクトップ・モバイル両対応）
- **返礼管理統合**: 配分込み金額を反映した返礼管理システム実装
- **返礼情報配分表示強化**: 配分詳細可視化・統計画面配分込み計算完全実装

### 🚀 次のステップ（フェーズ8）
**最優先**: 共有返礼システムの実装
1. 共有グループの概念導入
2. 代表者による一括返礼機能
3. 費用分担計算機能
4. 返礼品推奨システム

### 🎯 今回の成果（フェーズ7完了）
- **返礼情報テーブル配分詳細表示**: 強化されたお供物配分カラム実装
- **統計画面配分込み金額計算**: 通常・管理者統計両方で配分込み対応
- **カードリスト配分状況表示**: 詳細な配分情報と視覚的インディケーター
- **配分詳細ダイアログ統合**: 全画面での配分情報アクセス統一

### 📊 実装機能サマリー（フェーズ7追加）
- ✅ **返礼情報テーブル**: 配分件数・総額・詳細展開ボタン
- ✅ **統計画面**: 香典+お供物配分の分離表示・配分込み分布計算
- ✅ **返礼カード**: お供物配分詳細・配分詳細ダイアログアクセス
- ✅ **視覚的インディケーター**: 配分あり/なしの色分け・バッジ表示

### 📊 テスト実行結果
```bash
bun run test -- src/app/_actions/offerings/__tests__ --run
✓ src/app/_actions/offerings/__tests__/allocation.test.ts (9)
✓ src/app/_actions/offerings/__tests__/queries.test.ts (10)  
✓ src/app/_actions/offerings/__tests__/integration.test.ts (6)
✓ src/app/_actions/offerings/__tests__/ui-integration.test.tsx (5)
Test Files  4 passed (4)
Tests  30 passed (30)
```

---

**作成日**: 2024年1月30日  
**最終更新**: 2024年1月30日（フェーズ7完了、返礼情報配分状況可視化強化実装済み）  
**担当**: システム開発チーム  
**次回更新**: フェーズ8 共有返礼システム完了後 